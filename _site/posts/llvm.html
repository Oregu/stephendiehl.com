<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>

    <!-- Basic Page Needs
  ================================================== -->
    <meta charset="utf-8">
    <title>The Unholy Union of Python and Haskell through LLVM</title>
    <meta name="description" content="{{description}}">
    <meta name="author" content="{{author}}">

    <!-- Mobile Specific Metas
  ================================================== -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- CSS
  ================================================== -->
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/skeleton.css">
    <link rel="stylesheet" href="../css/typography.css">
    <link rel="stylesheet" href="../css/layout.css">
    <link rel="stylesheet" href="../css/syntax.css">
    <link rel="stylesheet" href="../css/custom.css">

    <link href="http://fonts.googleapis.com/css?family=Droid+Sans:400,700|Droid+Serif:400,400italic|Inconsolata" rel="stylesheet">
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
          inlineMath: [ ['$','$'], ['\\(','\\)'] ],
          // Needs to escaped for Pandoc
          displayMath: [ ["\\[","\\]"] ],
          processEscapes: true
        },
        "HTML-CSS": { availableFonts: ["TeX"] }
      });
    </script>

    <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Favicons
    ================================================== -->
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">

</head>
<body>

    <!-- Primary Page Layout
    ================================================== -->

    <div class="container">
        <div class="three columns sidebar">
            <nav>
                <h3 id="logo">Stephen Diehl</h3>
                <ul>
                    <li><a href="../">Index</a></li>
                    <li><a href="../posts.html">Writings</a></li>
                    <li><a href="../pages/projects.html">Projects</a></li>
                    <li><a href="../pages/hire.html">Hire Me</a></li>
                    <li><a href="../pages/pgp.html">PGP Key</a></li>
                    <li><a href="https://github.com/sdiehl">Github</a></li>
                    <li><a href="https://twitter.com/#!/smdiehl">Twitter</a></li>
                </ul>
            </nav>
             
        </div>

        <div class="twelve columns offset-by-one content">
            <h3 id="the-unholy-union-of-python-and-haskell-through-llvm">The Unholy Union of Python and Haskell through LLVM</h3>
<p>This is a crazy experiment in trying to import GHC generated LLVM bitcode directly into the Python runtime.</p>
<p>See the code here: <a href="https://github.com/sdiehl/bitey-haskell">https://github.com/sdiehl/bitey-haskell</a></p>
<p>You’ll need a lot of bleeding edge stuff to even try and attempt this.</p>
<p>Depending on your system you’ll probably need to compile LLVM, GHC, and llvm-py from source. If you don’t feel like spending up 5 or 6 hours hours of your life to building a compiler pipeline then best turn away now!</p>
<ul>
<li>LLVM 3.1</li>
<li>Head of the GHC source tree</li>
<li>llvm-py linked against LLVM 3.1</li>
<li>Bitey ( should be easy to install after llvm-py )</li>
<li>Optional: Bryan O’Sullivan’s llvm codegen library linked against LLVM 3.1</li>
</ul>
<h4 id="compiling-llvm">Compiling LLVM</h4>
<p>You need the latest LLVM 3.1. You’ll probably need to compile from source or grab the binaries for your platform and sub in the path in the steps below.</p>
<ul>
<li>http://llvm.org/releases/</li>
</ul>
<h4 id="compiling-the-glorious-haskell-compiler">Compiling the Glorious Haskell Compiler</h4>
<p>The LLVM backend supposedly works well on Linux and BSD derivatives but I have not tested it on anything other than x86 Linux. When trying this out my platform was:</p>
<ul>
<li>Arch Linux x86_64</li>
<li>gcc (GCC) 4.6.1 20110819 (prerelease)</li>
</ul>
<pre class="sourceCode bash"><code class="sourceCode bash">$ git clone http://darcs.haskell.org/ghc.git/
$ <span class="kw">cd</span> ghc
$ ./sync-all --testsuite get
$ <span class="kw">perl</span> boot</code></pre>
<p>Then you’ll need to create <code>mk/build.mk</code> . Note that we’re turning off optimization of the Stage 2 build so performance will suck.</p>
<pre class="sourceCode bash"><code class="sourceCode bash">SRC_HC_OPTS     = -O -H64m
GhcStage1HcOpts = -O -fllvm
GhcStage2HcOpts = -O0 -fasm
GhcHcOpts       = -Rghc-timing
GhcLibHcOpts    = -O0
GhcLibWays     = v
GhcWithLlvmCodeGen = YES

ifeq <span class="st">&quot;</span><span class="ot">$(</span>PlatformSupportsSharedLibs<span class="ot">)</span><span class="st">&quot;</span> <span class="st">&quot;YES&quot;</span>
GhcLibWays += dyn
endif</code></pre>
<p>Note: Both <code>opt</code> and <code>llc</code> must be on your PATH!</p>
<p>Then build. That will take a few hours.</p>
<pre><code>$ ./configure
$ make</code></pre>
<p>After you’ve compiled it and subsequently increased the entropy of the universe, you should now have a fresh <code>ghc-cabal</code> and <code>ghc-stage1</code> inside of the <code>inplace</code> folder. Let’s try out the new compiler. Make a hello.hs with the following</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">import</span> <span class="dt">System.IO</span>

main <span class="fu">=</span> <span class="kw">do</span>
    <span class="fu">putStrLn</span> <span class="st">&quot;Hello World&quot;</span></code></pre>
<p>And compile and run:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ inplace/bin/ghc-stage1 --make -fllvm hello.hs
$ ./hello
Hello World</code></pre>
<p>If you check the info of your new compiler it should look something like this:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ inplace/bin/ghc-stage1 --inf
  [<span class="kw">(</span><span class="st">&quot;Project name&quot;</span>,<span class="st">&quot;The Glorious Glasgow Haskell Compilation System&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;GCC extra via C opts&quot;</span>,<span class="st">&quot; -fwrapv&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;C compiler command&quot;</span>,<span class="st">&quot;/usr/lib/colorgcc/bin/gcc&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;C compiler flags&quot;</span>,<span class="st">&quot; -fno-stack-protector  -Wl,--hash-size=31 -Wl,--reduce-memory-overheads&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;ld flags&quot;</span>,<span class="st">&quot;     --hash-size=31     --reduce-memory-overheads&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;ld supports compact unwind&quot;</span>,<span class="st">&quot;YES&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;ld supports build-id&quot;</span>,<span class="st">&quot;YES&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;ld is GNU ld&quot;</span>,<span class="st">&quot;YES&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;ar command&quot;</span>,<span class="st">&quot;/usr/bin/ar&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;ar flags&quot;</span>,<span class="st">&quot;q&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;ar supports at file&quot;</span>,<span class="st">&quot;YES&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;touch command&quot;</span>,<span class="st">&quot;touch&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;dllwrap command&quot;</span>,<span class="st">&quot;/bin/false&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;windres command&quot;</span>,<span class="st">&quot;/bin/false&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;perl command&quot;</span>,<span class="st">&quot;/usr/bin/perl&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;target os&quot;</span>,<span class="st">&quot;OSLinux&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;target arch&quot;</span>,<span class="st">&quot;ArchX86_64&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;target word size&quot;</span>,<span class="st">&quot;8&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;target has GNU nonexec stack&quot;</span>,<span class="st">&quot;True&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;target has .ident directive&quot;</span>,<span class="st">&quot;True&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;target has subsections via symbols&quot;</span>,<span class="st">&quot;False&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;Unregisterised&quot;</span>,<span class="st">&quot;NO&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;LLVM llc command&quot;</span>,<span class="st">&quot;/usr/bin/llc&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;LLVM opt command&quot;</span>,<span class="st">&quot;/usr/bin/opt&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;Project version&quot;</span>,<span class="st">&quot;7.7.20120822&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;Booter version&quot;</span>,<span class="st">&quot;7.4.2&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;Stage&quot;</span>,<span class="st">&quot;1&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;Build platform&quot;</span>,<span class="st">&quot;x86_64-unknown-linux&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;Host platform&quot;</span>,<span class="st">&quot;x86_64-unknown-linux&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;Target platform&quot;</span>,<span class="st">&quot;x86_64-unknown-linux&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;Have interpreter&quot;</span>,<span class="st">&quot;YES&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;Object splitting supported&quot;</span>,<span class="st">&quot;YES&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;Have native code generator&quot;</span>,<span class="st">&quot;YES&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;Support SMP&quot;</span>,<span class="st">&quot;YES&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;Tables next to code&quot;</span>,<span class="st">&quot;YES&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;RTS ways&quot;</span>,<span class="st">&quot;l debug  thr thr_debug thr_l  dyn debug_dyn thr_dyn thr_debug_dyn&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;Leading underscore&quot;</span>,<span class="st">&quot;NO&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;Debug on&quot;</span>,<span class="st">&quot;False&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;LibDir&quot;</span>,<span class="st">&quot;/home/stephen/Git/ghc/inplace/lib&quot;</span><span class="kw">)</span>
 ,<span class="kw">(</span><span class="st">&quot;Global Package DB&quot;</span>,<span class="st">&quot;/home/stephen/Git/ghc/inplace/lib/package.conf.d&quot;</span><span class="kw">)</span>
 ]</code></pre>
<p>There is a ghc wrapper in the ghc-llvm folder. Ostensibly its a modified version of Don Stewarts ghc-core except it dumps the LLVM IR output for a a given file you pass to GHC. To install and use:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">cd</span> ghc-llvm
$ cabal <span class="kw">install</span>

<span class="co"># To use</span>
$ ghc-llvm hello.hs

%__stginit_Main_struct = <span class="kw">type</span> <span class="kw">&lt;</span><span class="dt">{}</span><span class="kw">&gt;</span>
@__stginit_Main =  global %__stginit_Main_struct<span class="kw">&lt;</span><span class="dt">{}</span><span class="kw">&gt;</span>
%sfR_srt_struct = <span class="kw">type</span> <span class="kw">&lt;</span><span class="dt">{i64}</span><span class="kw">&gt;</span>
@sfR_srt = internal constant %sfR_srt_struct<span class="kw">&lt;</span>{i64 ptrtoint <span class="kw">(</span>[0 x i64]* @ghczmprim_GHCziCString_unpackCStringzh_closure to i64<span class="kw">)</span>}<span class="kw">&gt;</span>
@ghczmprim_GHCziCString_unpackCStringzh_closure = external global [0 x i64]
%sfR_closure_struct = <span class="kw">type</span> <span class="kw">&lt;</span>{i64, i64, i64, i64}<span class="kw">&gt;</span>

...

<span class="co"># or</span>
$ ghc-llvm hello.hs <span class="kw">&gt;</span> hello.bc</code></pre>
<p>Its also worth noting that GHC lets you customize the path locations of <code>opt</code> and <code>llc</code>.</p>
<pre><code>-pgmlo - The program to use as the llvm optimiser
-pgmlc - The program to use as the llvm compiler</code></pre>
<h4 id="installing-llvm-py">Installing LLVM-PY</h4>
<p>Now you need to install llvm-py.</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ git clone https://github.com/llvmpy/llvmpy.git
$ python setup.py --llvm-config=<span class="kw">&lt;</span>PATH TO LLVM 3.<span class="kw">1&gt;</span></code></pre>
<p>Test it with:</p>
<pre class="sourceCode python"><code class="sourceCode python">$ python2
&gt;&gt;&gt; <span class="ch">import</span> llvm
&gt;&gt;&gt; <span class="ch">from</span> llvm <span class="ch">import</span> *</code></pre>
<h4 id="importing-with-bitey">Importing with Bitey</h4>
<p>Then modify the <code>Makefile</code> to reflect your system paths.</p>
<p>If everything works ( big if! ) you should then be able to run:</p>
<pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="kw">make</span>

..<span class="kw">.</span> lots of intermediate output ...</code></pre>
<p>Now create a <code>Test.hs</code> module.</p>
<pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">{-# Language MagicHash #-}</span>

<span class="kw">import</span> <span class="dt">GHC.Prim</span>

<span class="ot">f ::</span> <span class="dt">Int</span><span class="fu">#</span> <span class="ot">-&gt;</span> <span class="dt">Int</span><span class="fu">#</span>
f <span class="fu">=</span> (<span class="fu">-#</span> <span class="dv">1</span><span class="fu">#</span>)

<span class="ot">g ::</span> <span class="dt">Int</span><span class="fu">#</span> <span class="ot">-&gt;</span> <span class="dt">Int</span><span class="fu">#</span>
g <span class="fu">=</span> (<span class="fu">-#</span> <span class="dv">2</span><span class="fu">#</span>)

<span class="ot">fib ::</span> <span class="dt">Int</span><span class="fu">#</span> <span class="ot">-&gt;</span> <span class="dt">Int</span><span class="fu">#</span>
fib (<span class="dv">0</span><span class="fu">#</span>) <span class="fu">=</span> <span class="dv">0</span><span class="fu">#</span> 
fib (<span class="dv">1</span><span class="fu">#</span>) <span class="fu">=</span> <span class="dv">1</span><span class="fu">#</span>
fib n <span class="fu">=</span> (<span class="fu">+#</span>) (f n) (g n)

main <span class="fu">=</span> <span class="kw">do</span>
    <span class="fu">return</span> ()</code></pre>
<p>Which should generate the LLVM bitcode for the Haskell module <code>Test.hs</code>. Cross your fingers and try and load it into bitey!</p>
<pre class="sourceCode python"><code class="sourceCode python">$ cd bitey-haskell
$ python2
&gt;&gt;&gt; <span class="ch">import</span> bitey
&gt;&gt;&gt; Test = bitey.load_library(<span class="st">'./bitey.o'</span>)
&gt;&gt;&gt; Test.f(<span class="dv">3</span>)
<span class="dv">2</span>
&gt;&gt;&gt; Test.g(<span class="dv">5</span>)
<span class="dv">3</span>
&gt;&gt;&gt; Test.fib(<span class="dv">8</span>)
<span class="dv">21</span></code></pre>
<p>Note: You’ll need to use the provided <code>haskell-bitey</code> Vanilla bitey won’t work with the Haskell flavored module.</p>
        </div>
    </div>

    <!-- JS
    ================================================== -->
    <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>

<!-- End Document
================================================== -->
</body>
